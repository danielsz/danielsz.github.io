<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-04-25 Thu 06:07 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The anatomy of a HTTP server</title>
<meta name="author" content="Daniel Szmulewicz" />
<meta name="generator" content="Org Mode" />
<style type="text/css">
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="css/grid.css">
<link rel="stylesheet" type="text/css" href="css/post.css">
<link rel="stylesheet" type="text/css" href="assets/fonts/charter/webfonts/stylesheet.css">
<link rel="stylesheet" type="text/css" href="css/typography.css">
<link href="https://fonts.googleapis.com/css?family=Merriweather+Sans|Roboto+Condensed|Source+Serif+Pro|Inconsolata" rel="stylesheet">
<script src="js/grid.js"></script>
<script src="js/fathom.js"></script>
<script>
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
// @license-end
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="index.html"> UP </a>
 |
 <a accesskey="H" href="index.html"> HOME </a>
</div><div id="content" class="content">
<header>
<h1 class="title">The anatomy of a HTTP server</h1>
</header><p>
A Computerphile video made me do it. Computerphile is a Youtube channel about computer science. It features professors explaining technical concepts in an informal setting. The drabness of the backdrop, often a lab, an empty classroom or an office, is compensated by the enthusiasm of the presenter, a jolliness in his demeanor. It is quite British, indeed.
</p>

<p>
The video in question is titled &ldquo;Coding a Web Server in 25 Lines&rdquo;. It does what is says, or it says what it does. One might wonder what the point is, though. The  world is awash with widely available, highly performant web servers. Education, of course! It&rsquo;s a fun little exercise that upon completion yields a somewhat functional web server. Direct a web browser at it, and voilà! On the Internet, nobody knows you&rsquo;re a dog.
</p>

<p>
That&rsquo;s all good and well, but if Computerphile just did it, why do it again? Glad you&rsquo;ve asked. Firstly, writing <a href="https://bruinsslot.jp/post/simple-http-webserver-in-c/">minimalist</a> web servers is a genre unto itself. No, <a href="https://github.com/nir9/fastws/blob/db265120800db324aaae6e6a883210eabce3d865/server.asm">seriously</a>. But there is something else, too. As a Lisper, I couldn&rsquo;t help but notice the workflow: an edit/compile/run affair. How I&rsquo;d prefer  to see the read/eval/print/loop route! Isn&rsquo;t REPL-based development the balm that will heal the world? That is, until a Smalltalker comes along and <a href="https://blog.bracha.org/primordialsoup.html?snapshot=AmpleforthViewer.vfuel&amp;docName=ReplacingREPLs">asks</a> why use a textual interface instead of a graphical one. Either way, interactive development environments à la Lisp, or Smalltalk for that matter, are far from commonplace, and there is plenty of room to make a statement. Sure, this could be an expression of smugness, delusion or loneliness.
</p>

<p>
We never want to be lonely again.
</p>

<p>
The one thing that Computerphile teaches you without fail is breaking down problems into smaller chunks. Arguably, the most important lesson of them all. Therefore, the first version of the web server presented to the audience is a diminutive one. It prints out the request and does nothing about it. In Rust, this gives the following:
</p>

<div class="org-src-container">
<pre class="src src-rust">  <span style="color: #a020f0;">use</span> <span style="color: #008b8b;">std</span>::<span style="color: #008b8b;">io</span>::<span style="color: #228b22;">BufRead</span>;

<span style="color: #a020f0;">fn</span> <span style="color: #0000ff;">main</span>() {
    <span style="color: #a020f0;">let</span> <span style="color: #a0522d;">listener</span> = <span style="color: #008b8b;">std</span>::<span style="color: #008b8b;">net</span>::<span style="color: #228b22;">TcpListener</span>::bind(<span style="color: #8b2252;">"127.0.0.1:9999"</span>).unwrap();
    <span style="color: #a020f0;">for</span> <span style="color: #a020f0;">mut</span> <span style="color: #a0522d;">stream</span> <span style="color: #a020f0;">in</span> listener.incoming().flatten() {
        <span style="color: #a020f0;">let</span> <span style="color: #a020f0;">mut</span> <span style="color: #a0522d;">rdr</span> = <span style="color: #008b8b;">std</span>::<span style="color: #008b8b;">io</span>::<span style="color: #228b22;">BufReader</span>::new(<span style="color: #000000; background-color: #ffffff;">&amp;</span><span style="color: #a020f0;">mut</span> stream);
        <span style="color: #a020f0;">let</span> <span style="color: #a020f0;">mut</span> <span style="color: #a0522d;">l</span> = <span style="color: #228b22;">String</span>::new();
        <span style="color: #a020f0;">loop</span> {
            rdr.read_line(<span style="color: #000000; background-color: #ffffff;">&amp;</span><span style="color: #a020f0;">mut</span> l).unwrap();
            <span style="color: #483d8b;">print!</span>(<span style="color: #8b2252;">"</span><span style="color: #8b2252; font-style: italic;">{l}</span><span style="color: #8b2252;">"</span>); 
        }
    }
}
</pre>
</div>

<p>
One might object that with <code>netcat</code>, this is a one-liner:
</p>

<div class="org-src-container">
<pre class="src src-shell">nc -vvv -l -s 127.0.0.1 -p 9999
</pre>
</div>

<p>
Sure. But it doesn&rsquo;t let transpire much of what is going on. The Rust snippet shows that TCP is the transport layer. The equivalent version in Clojure could look like the snippet below, where <code>ServerSocket</code> is the abstraction for TCP-based communication. 
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #a020f0;">import</span> java.net.ServerSocket<span style="color: #707183;">)</span>

<span style="color: #707183;">(</span><span style="color: #a020f0;">with-open</span> <span style="color: #7388d6;">[</span>server <span style="color: #909183;">(</span>ServerSocket. 8085<span style="color: #909183;">)</span>
            conn <span style="color: #909183;">(</span>.accept server<span style="color: #909183;">)</span>
            r <span style="color: #909183;">(</span><span style="color: #228b22;">io</span>/reader <span style="color: #709870;">(</span>.getInputStream conn<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388d6;">]</span>
  <span style="color: #7388d6;">(</span><span style="color: #a020f0;">loop</span> <span style="color: #909183;">[</span>line <span style="color: #709870;">(</span>.readLine r<span style="color: #709870;">)</span><span style="color: #909183;">]</span>
    <span style="color: #909183;">(</span><span style="color: #a020f0;">when</span> <span style="color: #709870;">(</span>seq <span style="color: #907373;">(</span><span style="color: #228b22;">str</span>/trim line<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #228b22;">log</span>/info line<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #a020f0;">recur</span> <span style="color: #907373;">(</span>.readLine r<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388d6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
Note the binding form following the <code>with-open</code> macro. The objects created within belong to classes implementing Java&rsquo;s <i>AutoCloseable</i> interface, therefore lending themselves to the <code>try-with-resources</code> <a href="https://docs.oracle.com/javase/tutorial/essential/exceptions/tryResourceClose.html">idiom</a>. Whereas in Java it is a statement introduced by the language designers with Java 7, in Clojure it is a <a href="https://github.com/clojure/clojure/blob/ce55092f2b2f5481d25cff6205470c1335760ef6/src/clj/clojure/core.clj#L3832">macro</a> that anyone could have written if it were indeed absent from the language. So there, we haven&rsquo;t missed the opportunity to praise the virtues of Lisp&rsquo;s homoiconicity.
</p>

<p>
This snippet of code is well and good but it makes the browser hang. It is waiting on the socket for a response, which isn&rsquo;t coming. So here is a minimal modification that sends a response. We&rsquo;ll just say OK to everyone.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #a020f0;">with-open</span> <span style="color: #7388d6;">[</span>server <span style="color: #909183;">(</span>ServerSocket. 8085<span style="color: #909183;">)</span>
            conn <span style="color: #909183;">(</span>.accept server<span style="color: #909183;">)</span>
            r <span style="color: #909183;">(</span><span style="color: #228b22;">io</span>/reader <span style="color: #709870;">(</span>.getInputStream conn<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
            w <span style="color: #909183;">(</span><span style="color: #228b22;">io</span>/writer <span style="color: #709870;">(</span>.getOutputStream conn<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388d6;">]</span>
  <span style="color: #7388d6;">(</span><span style="color: #a020f0;">loop</span> <span style="color: #909183;">[</span>line <span style="color: #709870;">(</span>.readLine r<span style="color: #709870;">)</span><span style="color: #909183;">]</span>
    <span style="color: #909183;">(</span><span style="color: #a020f0;">when</span> <span style="color: #709870;">(</span>seq <span style="color: #907373;">(</span><span style="color: #228b22;">str</span>/trim line<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #228b22;">log</span>/info line<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #a020f0;">recur</span> <span style="color: #907373;">(</span>.readLine r<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388d6;">)</span>
  <span style="color: #7388d6;">(</span>.write w <span style="color: #8b2252;">"HTTP/1.1 200 OK</span><span style="color: #8b2252; font-weight: bold;">\r\n\r\n</span><span style="color: #8b2252;">"</span><span style="color: #7388d6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
The problem now is that we&rsquo;re dealing with one request only. We ought to keep listening on the socket, processing multiple requests as they come. 
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #a020f0;">let</span> <span style="color: #7388d6;">[</span>server <span style="color: #909183;">(</span>ServerSocket. 8085<span style="color: #909183;">)</span><span style="color: #7388d6;">]</span>
  <span style="color: #7388d6;">(</span><span style="color: #a020f0;">loop</span> <span style="color: #909183;">[</span>conn <span style="color: #709870;">(</span>.accept server<span style="color: #709870;">)</span><span style="color: #909183;">]</span>
    <span style="color: #909183;">(</span><span style="color: #a020f0;">with-open</span> <span style="color: #709870;">[</span>r <span style="color: #907373;">(</span><span style="color: #228b22;">io</span>/reader <span style="color: #6276ba;">(</span>.getInputStream conn<span style="color: #6276ba;">)</span><span style="color: #907373;">)</span>
                w <span style="color: #907373;">(</span><span style="color: #228b22;">io</span>/writer <span style="color: #6276ba;">(</span>.getOutputStream conn<span style="color: #6276ba;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">]</span>
      <span style="color: #709870;">(</span><span style="color: #a020f0;">loop</span> <span style="color: #907373;">[</span>line <span style="color: #6276ba;">(</span>.readLine r<span style="color: #6276ba;">)</span><span style="color: #907373;">]</span>
        <span style="color: #907373;">(</span><span style="color: #a020f0;">when</span> <span style="color: #6276ba;">(</span>seq <span style="color: #858580;">(</span><span style="color: #228b22;">str</span>/trim line<span style="color: #858580;">)</span><span style="color: #6276ba;">)</span>
          <span style="color: #6276ba;">(</span><span style="color: #a020f0;">recur</span> <span style="color: #858580;">(</span>.readLine r<span style="color: #858580;">)</span><span style="color: #6276ba;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span>.write w <span style="color: #8b2252;">"HTTP/1.1 200 OK</span><span style="color: #8b2252; font-weight: bold;">\r\n\r\n</span><span style="color: #8b2252;">"</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #a020f0;">recur</span> <span style="color: #709870;">(</span>.accept server<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388d6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
Great. Now a word about our workflow. Executed in a REPL, the snippet above will block the top-level loop. In other words, we don&rsquo;t get our prompt back. This is a problem, because this would force us to restart the REPL. We never want to restart our REPL. Now, in an interruptible REPL such as Cider, we can press <code>C-c C-b</code> or <code>Alt+x cider-interrupt</code> to get back to the prompt. But if you try to rerun the code, you will get a <code>BindException</code>. The server wasn&rsquo;t closed properly and it is still bound to the address, port 8085 on the loopback interface. In brief, we need to keep a handle on the server so that we can gracefully close it.
</p>

<p>
The lesson here is that at a REPL, thought must be given to state, its initialization and its tear down. There are many solutions available to us, and some of them are reified in libraries, but here we will opt for a straightforward solution, yet no less effective. Instead of writing code at the top-level, we will encapsulate it in a function. And that function will receive the server as argument.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">tcp-transport</span> <span style="color: #7388d6;">[</span>server<span style="color: #7388d6;">]</span>
  <span style="color: #7388d6;">(</span><span style="color: #a020f0;">while</span> <span style="color: #909183;">(</span>not <span style="color: #709870;">(</span>.isClosed server<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #a020f0;">loop</span> <span style="color: #709870;">[</span>conn <span style="color: #907373;">(</span>.accept server<span style="color: #907373;">)</span><span style="color: #709870;">]</span>
      <span style="color: #709870;">(</span><span style="color: #a020f0;">with-open</span> <span style="color: #907373;">[</span>r <span style="color: #6276ba;">(</span><span style="color: #228b22;">io</span>/reader <span style="color: #858580;">(</span>.getInputStream conn<span style="color: #858580;">)</span><span style="color: #6276ba;">)</span>
                  w <span style="color: #6276ba;">(</span><span style="color: #228b22;">io</span>/writer <span style="color: #858580;">(</span>.getOutputStream conn<span style="color: #858580;">)</span><span style="color: #6276ba;">)</span><span style="color: #907373;">]</span>
        <span style="color: #907373;">(</span><span style="color: #a020f0;">loop</span> <span style="color: #6276ba;">[</span>line <span style="color: #858580;">(</span>.readLine r<span style="color: #858580;">)</span><span style="color: #6276ba;">]</span>
          <span style="color: #6276ba;">(</span><span style="color: #a020f0;">when</span> <span style="color: #858580;">(</span>seq <span style="color: #80a880;">(</span><span style="color: #228b22;">str</span>/trim line<span style="color: #80a880;">)</span><span style="color: #858580;">)</span>
            <span style="color: #858580;">(</span><span style="color: #a020f0;">recur</span> <span style="color: #80a880;">(</span>.readLine r<span style="color: #80a880;">)</span><span style="color: #858580;">)</span><span style="color: #6276ba;">)</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span>.write w <span style="color: #8b2252;">"HTTP/1.1 200 OK</span><span style="color: #8b2252; font-weight: bold;">\r\n\r\n</span><span style="color: #8b2252;">"</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #a020f0;">recur</span> <span style="color: #907373;">(</span>.accept server<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388d6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
Now we can write:
</p>
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #a020f0;">def</span> <span style="color: #a0522d;">server</span> <span style="color: #7388d6;">(</span>ServerSocket. 8085<span style="color: #7388d6;">)</span><span style="color: #707183;">)</span>
<span style="color: #707183;">(</span>tcp-listener server<span style="color: #707183;">)</span>
</pre>
</div>

<p>
In order to get back to a clean state:
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span>.close server<span style="color: #707183;">)</span>
</pre>
</div>

<p>
Close, but not there yet. We need to run the server in its own thread so that it doesn&rsquo;t interfere with our top-level at the REPL. Handily, wrapping the code in a <code>future</code> will achieve the desired result. 
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">tcp-transport</span> <span style="color: #7388d6;">[</span>server<span style="color: #7388d6;">]</span>
  <span style="color: #7388d6;">(</span><span style="color: #a020f0;">future</span> 
    <span style="color: #909183;">(</span><span style="color: #a020f0;">while</span> <span style="color: #709870;">(</span>not <span style="color: #907373;">(</span>.isClosed server<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #a020f0;">loop</span> <span style="color: #907373;">[</span>conn <span style="color: #6276ba;">(</span>.accept server<span style="color: #6276ba;">)</span><span style="color: #907373;">]</span>
        <span style="color: #907373;">(</span><span style="color: #a020f0;">with-open</span> <span style="color: #6276ba;">[</span>r <span style="color: #858580;">(</span><span style="color: #228b22;">io</span>/reader <span style="color: #80a880;">(</span>.getInputStream conn<span style="color: #80a880;">)</span><span style="color: #858580;">)</span>
                    w <span style="color: #858580;">(</span><span style="color: #228b22;">io</span>/writer <span style="color: #80a880;">(</span>.getOutputStream conn<span style="color: #80a880;">)</span><span style="color: #858580;">)</span><span style="color: #6276ba;">]</span>
          <span style="color: #6276ba;">(</span><span style="color: #a020f0;">loop</span> <span style="color: #858580;">[</span>line <span style="color: #80a880;">(</span>.readLine r<span style="color: #80a880;">)</span><span style="color: #858580;">]</span>
            <span style="color: #858580;">(</span><span style="color: #a020f0;">when</span> <span style="color: #80a880;">(</span>seq <span style="color: #887070;">(</span><span style="color: #228b22;">str</span>/trim line<span style="color: #887070;">)</span><span style="color: #80a880;">)</span>
              <span style="color: #80a880;">(</span><span style="color: #228b22;">log</span>/info line<span style="color: #80a880;">)</span>
              <span style="color: #80a880;">(</span><span style="color: #a020f0;">recur</span> <span style="color: #887070;">(</span>.readLine r<span style="color: #887070;">)</span><span style="color: #80a880;">)</span><span style="color: #858580;">)</span><span style="color: #6276ba;">)</span>
          <span style="color: #6276ba;">(</span>.write w <span style="color: #8b2252;">"HTTP/1.1 200 OK</span><span style="color: #8b2252; font-weight: bold;">\r\n\r\n</span><span style="color: #8b2252;">"</span><span style="color: #6276ba;">)</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #a020f0;">recur</span> <span style="color: #6276ba;">(</span>.accept server<span style="color: #6276ba;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388d6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
This is shaping up nicely. There is a tiny annoyance, though. When we call the close method on the sever instance, the underlying socket (<code>conn</code>) is left hanging, and that generates an error which becomes apparent only if we dereference the future.
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #228b22;">Execution</span> <span style="color: #0000ff;">error</span> (<span style="color: #228b22;">SocketException</span>) at <span style="color: #008b8b;">sun</span>.<span style="color: #008b8b;">nio</span>.<span style="color: #008b8b;">ch</span>.NioSocketImpl/endAccept (NioSocketImpl.java:694).
Socket closed
</pre>
</div>

<p>
It has no consequences since the thread has ended, but we can do the following gentle adjustment which catches the exception. 
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">tcp-transport</span> <span style="color: #7388d6;">[</span>server<span style="color: #7388d6;">]</span>
  <span style="color: #7388d6;">(</span><span style="color: #a020f0;">future</span> 
    <span style="color: #909183;">(</span><span style="color: #a020f0;">try</span> <span style="color: #709870;">(</span><span style="color: #a020f0;">while</span> <span style="color: #907373;">(</span>not <span style="color: #6276ba;">(</span>.isClosed server<span style="color: #6276ba;">)</span><span style="color: #907373;">)</span>
           <span style="color: #907373;">(</span><span style="color: #a020f0;">loop</span> <span style="color: #6276ba;">[</span>conn <span style="color: #858580;">(</span>.accept server<span style="color: #858580;">)</span><span style="color: #6276ba;">]</span>
             <span style="color: #6276ba;">(</span><span style="color: #a020f0;">with-open</span> <span style="color: #858580;">[</span>r <span style="color: #80a880;">(</span><span style="color: #228b22;">io</span>/reader <span style="color: #887070;">(</span>.getInputStream conn<span style="color: #887070;">)</span><span style="color: #80a880;">)</span>
                         w <span style="color: #80a880;">(</span><span style="color: #228b22;">io</span>/writer <span style="color: #887070;">(</span>.getOutputStream conn<span style="color: #887070;">)</span><span style="color: #80a880;">)</span><span style="color: #858580;">]</span>
               <span style="color: #858580;">(</span><span style="color: #a020f0;">loop</span> <span style="color: #80a880;">[</span>line <span style="color: #887070;">(</span>.readLine r<span style="color: #887070;">)</span><span style="color: #80a880;">]</span>
                 <span style="color: #80a880;">(</span><span style="color: #a020f0;">when</span> <span style="color: #887070;">(</span>seq <span style="color: #707183;">(</span><span style="color: #228b22;">str</span>/trim line<span style="color: #707183;">)</span><span style="color: #887070;">)</span>
                   <span style="color: #887070;">(</span><span style="color: #a020f0;">recur</span> <span style="color: #707183;">(</span>.readLine r<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80a880;">)</span><span style="color: #858580;">)</span>
               <span style="color: #858580;">(</span>.write w <span style="color: #8b2252;">"HTTP/1.1 200 OK</span><span style="color: #8b2252; font-weight: bold;">\r\n\r\n</span><span style="color: #8b2252;">"</span><span style="color: #858580;">)</span><span style="color: #6276ba;">)</span>
             <span style="color: #6276ba;">(</span><span style="color: #a020f0;">recur</span> <span style="color: #858580;">(</span>.accept server<span style="color: #858580;">)</span><span style="color: #6276ba;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
         <span style="color: #709870;">(</span><span style="color: #a020f0;">catch</span> SocketException e <span style="color: #907373;">(</span>.getMessage e<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388d6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
Now when you dereference the future, it will report:
</p>
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8b2252;">"Socket closed"</span>
</pre>
</div>

<p>
If you have watched the video, you know that the web server, after being coaxed into saying OK to all requests, gets upgraded so that it can actually serve content. That second version is able deliver the presenter&rsquo;s personal static website to the browser. We are going to do the same moves now. First, we will teach our web server to parse the request and extract the URI, the resource being requested. The first line of a HTTP request contains the URI.
</p>

<div class="org-src-container">
<pre class="src src-shell">GET /index.html HTTP/1.1
</pre>
</div>

<p>
If we split the string at the space boundary, it is going to be the second element. Hence:
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #a020f0;">loop</span> <span style="color: #7388d6;">[</span>line <span style="color: #909183;">(</span>.readLine r<span style="color: #909183;">)</span><span style="color: #7388d6;">]</span>
  <span style="color: #7388d6;">(</span><span style="color: #a020f0;">when</span> <span style="color: #909183;">(</span>seq <span style="color: #709870;">(</span><span style="color: #228b22;">str</span>/trim line<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #a020f0;">when</span> <span style="color: #709870;">(</span><span style="color: #228b22;">str</span>/starts-with? line <span style="color: #8b2252;">"GET"</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #228b22;">log</span>/info line<span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span>reset! resource <span style="color: #907373;">(</span>second <span style="color: #6276ba;">(</span><span style="color: #228b22;">str</span>/split line #<span style="color: #8b2252;">" "</span><span style="color: #6276ba;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #a020f0;">recur</span> <span style="color: #709870;">(</span>.readLine r<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388d6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
Where resource is an atom used for the assignment. However, we are functional programmers and we&rsquo;d like to avoid the assignment. We&rsquo;ll see how in a moment. For now, let&rsquo;s ignore the ickiness and move along. In an ideal world, we can write the following program:
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">tcp-transport</span> <span style="color: #7388d6;">[</span>server<span style="color: #7388d6;">]</span>
  <span style="color: #7388d6;">(</span><span style="color: #a020f0;">let</span> <span style="color: #909183;">[</span>path <span style="color: #8b2252;">"/tmp/resources"</span><span style="color: #909183;">]</span>
    <span style="color: #909183;">(</span><span style="color: #a020f0;">future</span>
      <span style="color: #709870;">(</span><span style="color: #a020f0;">try</span>
        <span style="color: #907373;">(</span><span style="color: #a020f0;">while</span> <span style="color: #6276ba;">(</span>not <span style="color: #858580;">(</span>.isClosed server<span style="color: #858580;">)</span><span style="color: #6276ba;">)</span>
          <span style="color: #6276ba;">(</span><span style="color: #a020f0;">loop</span> <span style="color: #858580;">[</span>conn <span style="color: #80a880;">(</span>.accept server<span style="color: #80a880;">)</span>
                 resource <span style="color: #80a880;">(</span>atom <span style="color: #008b8b;">nil</span><span style="color: #80a880;">)</span><span style="color: #858580;">]</span>
            <span style="color: #858580;">(</span><span style="color: #a020f0;">with-open</span> <span style="color: #80a880;">[</span>r <span style="color: #887070;">(</span><span style="color: #228b22;">io</span>/reader <span style="color: #707183;">(</span>.getInputStream conn<span style="color: #707183;">)</span><span style="color: #887070;">)</span>
                        w <span style="color: #887070;">(</span><span style="color: #228b22;">io</span>/writer <span style="color: #707183;">(</span>.getOutputStream conn<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80a880;">]</span>
              <span style="color: #80a880;">(</span><span style="color: #a020f0;">loop</span> <span style="color: #887070;">[</span>line <span style="color: #707183;">(</span>.readLine r<span style="color: #707183;">)</span><span style="color: #887070;">]</span>
                <span style="color: #887070;">(</span><span style="color: #a020f0;">when</span> <span style="color: #707183;">(</span>seq <span style="color: #7388d6;">(</span><span style="color: #228b22;">str</span>/trim line<span style="color: #7388d6;">)</span><span style="color: #707183;">)</span>
                  <span style="color: #707183;">(</span><span style="color: #a020f0;">when</span> <span style="color: #7388d6;">(</span><span style="color: #228b22;">str</span>/starts-with? line <span style="color: #8b2252;">"GET"</span><span style="color: #7388d6;">)</span>
                    <span style="color: #7388d6;">(</span><span style="color: #228b22;">log</span>/info line<span style="color: #7388d6;">)</span>
                    <span style="color: #7388d6;">(</span>reset! resource <span style="color: #909183;">(</span>second <span style="color: #709870;">(</span><span style="color: #228b22;">str</span>/split line #<span style="color: #8b2252;">" "</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388d6;">)</span><span style="color: #707183;">)</span>
                  <span style="color: #707183;">(</span><span style="color: #a020f0;">recur</span> <span style="color: #7388d6;">(</span>.readLine r<span style="color: #7388d6;">)</span><span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80a880;">)</span>
              <span style="color: #80a880;">(</span><span style="color: #a020f0;">let</span> <span style="color: #887070;">[</span>ok <span style="color: #707183;">(</span>str <span style="color: #8b2252;">"HTTP/1.1 200 OK</span><span style="color: #8b2252; font-weight: bold;">\r\n\r\n</span><span style="color: #8b2252;">"</span><span style="color: #707183;">)</span>
                    file <span style="color: #707183;">(</span>str path @resource<span style="color: #707183;">)</span><span style="color: #887070;">]</span>
                <span style="color: #887070;">(</span>.write w <span style="color: #707183;">(</span>str ok file<span style="color: #707183;">)</span><span style="color: #887070;">)</span><span style="color: #80a880;">)</span><span style="color: #858580;">)</span>
            <span style="color: #858580;">(</span><span style="color: #a020f0;">recur</span> <span style="color: #80a880;">(</span>.accept server<span style="color: #80a880;">)</span> resource<span style="color: #858580;">)</span><span style="color: #6276ba;">)</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #a020f0;">catch</span> SocketException e <span style="color: #6276ba;">{</span><span style="color: #008b8b;">:msg</span> <span style="color: #858580;">(</span>.getMessage e<span style="color: #858580;">)</span><span style="color: #6276ba;">}</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388d6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
Except that ideal worlds are the realm of fairy tales. We can&rsquo;t just pretend that the requested resource always exists. We can see where this is going:
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #a020f0;">let</span> <span style="color: #7388d6;">[</span>ok <span style="color: #909183;">(</span>str <span style="color: #8b2252;">"HTTP/1.1 200 OK</span><span style="color: #8b2252; font-weight: bold;">\r\n\r\n</span><span style="color: #8b2252;">"</span><span style="color: #909183;">)</span>
      not-found <span style="color: #909183;">(</span>str <span style="color: #8b2252;">"HTTP/1.1 404 Not Found</span><span style="color: #8b2252; font-weight: bold;">\r\n\r\n</span><span style="color: #8b2252;">"</span><span style="color: #909183;">)</span>
      file <span style="color: #909183;">(</span><span style="color: #a020f0;">try</span> <span style="color: #709870;">(</span>slurp <span style="color: #907373;">(</span>str path @resource<span style="color: #907373;">)</span><span style="color: #709870;">)</span>
                <span style="color: #709870;">(</span><span style="color: #a020f0;">catch</span> FileNotFoundException e<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388d6;">]</span>
  <span style="color: #7388d6;">(</span><span style="color: #a020f0;">if</span> <span style="color: #909183;">(</span>seq file<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>.write w <span style="color: #709870;">(</span>str resp file<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>.write w not-found<span style="color: #909183;">)</span><span style="color: #7388d6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
More logic. But hey, our web server can now serve resources from a folder. We have caught up with the Computerphile video. The demonstration is over. We too have done the <i>Hello, World!</i> web server, and then an upgraded version serving static resources. But really, this is no way to say goodbye. Our web server is one mess of a function. It does way too much: listening on a <i>TCP port</i>, parsing the request, crafting the response. And on top of that we&rsquo;re doing a mutation. Can you believe that? It&rsquo;s high time for a refactoring. 
</p>

<p>
We&rsquo;ve just mentioned how to better separate concerns, so let&rsquo;s do that, starting with parsing the request:
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">parse-request</span> <span style="color: #7388d6;">[</span>conn<span style="color: #7388d6;">]</span>
  <span style="color: #7388d6;">(</span><span style="color: #a020f0;">let</span> <span style="color: #909183;">[</span>r <span style="color: #709870;">(</span><span style="color: #228b22;">io</span>/reader <span style="color: #907373;">(</span>.getInputStream conn<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">]</span>
    <span style="color: #909183;">(</span><span style="color: #a020f0;">loop</span> <span style="color: #709870;">[</span>line <span style="color: #907373;">(</span>.readLine r<span style="color: #907373;">)</span>
           request <span style="color: #907373;">{}</span><span style="color: #709870;">]</span>
      <span style="color: #709870;">(</span><span style="color: #a020f0;">if</span> <span style="color: #907373;">(</span>seq <span style="color: #6276ba;">(</span><span style="color: #228b22;">str</span>/trim line<span style="color: #6276ba;">)</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #a020f0;">if</span> <span style="color: #6276ba;">(</span><span style="color: #228b22;">str</span>/starts-with? line <span style="color: #8b2252;">"GET"</span><span style="color: #6276ba;">)</span>
          <span style="color: #6276ba;">(</span><span style="color: #a020f0;">let</span> <span style="color: #858580;">[</span><span style="color: #80a880;">[</span>method uri scheme<span style="color: #80a880;">]</span> <span style="color: #80a880;">(</span><span style="color: #228b22;">str</span>/split line #<span style="color: #8b2252;">" "</span><span style="color: #80a880;">)</span><span style="color: #858580;">]</span>
            <span style="color: #858580;">(</span><span style="color: #a020f0;">recur</span> <span style="color: #80a880;">(</span>.readLine r<span style="color: #80a880;">)</span> <span style="color: #80a880;">(</span>assoc request <span style="color: #008b8b;">:method</span> method <span style="color: #008b8b;">:uri</span> uri <span style="color: #008b8b;">:scheme</span> scheme<span style="color: #80a880;">)</span><span style="color: #858580;">)</span><span style="color: #6276ba;">)</span>
          <span style="color: #6276ba;">(</span><span style="color: #a020f0;">let</span> <span style="color: #858580;">[</span><span style="color: #80a880;">[</span>k v<span style="color: #80a880;">]</span> <span style="color: #80a880;">(</span><span style="color: #228b22;">str</span>/split line #<span style="color: #8b2252;">":"</span><span style="color: #80a880;">)</span><span style="color: #858580;">]</span>
            <span style="color: #858580;">(</span><span style="color: #a020f0;">recur</span> <span style="color: #80a880;">(</span>.readLine r<span style="color: #80a880;">)</span> <span style="color: #80a880;">(</span>assoc request <span style="color: #008b8b;">:headers</span> <span style="color: #887070;">{</span>k v<span style="color: #887070;">}</span><span style="color: #80a880;">)</span><span style="color: #858580;">)</span><span style="color: #6276ba;">)</span><span style="color: #907373;">)</span>
        request<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388d6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
Look, ma, no mutation! Instead, we&rsquo;re accumulating each header line in the request map, and that is what the function returns. It seems we&rsquo;ve been feeding a couple of birds with one scone. That request can now be passed on to our new response function: 
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">send-response</span> <span style="color: #7388d6;">[</span>conn request<span style="color: #7388d6;">]</span>
  <span style="color: #7388d6;">(</span><span style="color: #a020f0;">let</span> <span style="color: #909183;">[</span>path <span style="color: #8b2252;">"/tmp/resources"</span><span style="color: #909183;">]</span>
    <span style="color: #909183;">(</span><span style="color: #a020f0;">with-open</span> <span style="color: #709870;">[</span>w <span style="color: #907373;">(</span><span style="color: #228b22;">io</span>/writer <span style="color: #6276ba;">(</span>.getOutputStream conn<span style="color: #6276ba;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">]</span>
      <span style="color: #709870;">(</span><span style="color: #a020f0;">if</span> <span style="color: #907373;">(</span>.exists <span style="color: #6276ba;">(</span><span style="color: #228b22;">io</span>/file <span style="color: #858580;">(</span>str path <span style="color: #80a880;">(</span><span style="color: #008b8b;">:uri</span> request<span style="color: #80a880;">)</span><span style="color: #858580;">)</span><span style="color: #6276ba;">)</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #a020f0;">let</span> <span style="color: #6276ba;">[</span>resource <span style="color: #858580;">(</span>slurp <span style="color: #80a880;">(</span>str path <span style="color: #887070;">(</span><span style="color: #008b8b;">:uri</span> request<span style="color: #887070;">)</span><span style="color: #80a880;">)</span><span style="color: #858580;">)</span><span style="color: #6276ba;">]</span>
          <span style="color: #6276ba;">(</span>.write w <span style="color: #858580;">(</span>str <span style="color: #8b2252;">"HTTP/1.1 200 OK</span><span style="color: #8b2252; font-weight: bold;">\r\n\r\n</span><span style="color: #8b2252;">"</span> resource<span style="color: #858580;">)</span><span style="color: #6276ba;">)</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span>.write w <span style="color: #8b2252;">"HTTP/1.1 404 Not Found</span><span style="color: #8b2252; font-weight: bold;">\r\n\r\n</span><span style="color: #8b2252;">"</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388d6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
Tying everything together:
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">tcp-transport</span> <span style="color: #7388d6;">[</span>server<span style="color: #7388d6;">]</span>
  <span style="color: #7388d6;">(</span><span style="color: #a020f0;">future</span>
    <span style="color: #909183;">(</span><span style="color: #a020f0;">try</span>
      <span style="color: #709870;">(</span><span style="color: #a020f0;">while</span> <span style="color: #907373;">(</span>not <span style="color: #6276ba;">(</span>.isClosed server<span style="color: #6276ba;">)</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #a020f0;">loop</span> <span style="color: #6276ba;">[</span>conn <span style="color: #858580;">(</span>.accept server<span style="color: #858580;">)</span><span style="color: #6276ba;">]</span>
          <span style="color: #6276ba;">(</span><span style="color: #a020f0;">let</span> <span style="color: #858580;">[</span>request <span style="color: #80a880;">(</span>parse-request conn<span style="color: #80a880;">)</span><span style="color: #858580;">]</span>
            <span style="color: #858580;">(</span>send-response conn request<span style="color: #858580;">)</span><span style="color: #6276ba;">)</span>
          <span style="color: #6276ba;">(</span><span style="color: #a020f0;">recur</span> <span style="color: #858580;">(</span>.accept server<span style="color: #858580;">)</span><span style="color: #6276ba;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #a020f0;">catch</span> SocketException e <span style="color: #907373;">{</span><span style="color: #008b8b;">:msg</span> <span style="color: #6276ba;">(</span>.getMessage e<span style="color: #6276ba;">)</span><span style="color: #907373;">}</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388d6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
Remember when I enumerated the reasons behind yet another minimalist web server. I said that we wanted to show the power of REPL-based development? Well, there&rsquo;s another reason why I think this exercise is worth pursuing. We are not going to stop with a minimal web server. Our web server will be Ring-compliant. This transforms our static web server, one that serves static resources, to a dynamic web server, one that is driven by a program, any program, as long as it takes a request as parameter and produces a response as return value. In Ring speak, this is called a handler.
</p>

<blockquote>
<p>
Ring is a Clojure web applications library inspired by Python&rsquo;s WSGI and Ruby&rsquo;s Rack. By abstracting the details of HTTP into a simple, unified API, Ring allows web applications to be constructed of modular components that can be shared among a variety of applications, web servers, and web frameworks.
</p>
</blockquote>

<p>
Next to the handler, the Ring spec defines the request map, its required keys. Some of which we&rsquo;ve already seen, the URI, the method and the scheme that we extract from the first line of a HTTP request. The response map consists of a headers and a status key. If present, the body must satisfy a protocol:
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #a020f0;">defprotocol</span> <span style="color: #228b22;">StreamableResponseBody</span>
  <span style="color: #7388d6;">(</span>write-body-to-stream <span style="color: #909183;">[</span>body response output-stream<span style="color: #909183;">]</span><span style="color: #7388d6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
The spec is of interest to us because we&rsquo;re implementing a web server, but the user doesn&rsquo;t need to care about these intricacies. From his perspective, the handler is important, because it defines the behavior of his web application. And that handler will be passed to the Ring adapter, which will start the HTTP server. The adapter, thus, is the entry point and has the following signature.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span>run-adapter handler options<span style="color: #707183;">)</span>
</pre>
</div>

<p>
We can thus write the following:
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">run-adapter</span> <span style="color: #7388d6;">[</span>handler options<span style="color: #7388d6;">]</span>
  <span style="color: #7388d6;">(</span><span style="color: #a020f0;">let</span> <span style="color: #909183;">[</span>server <span style="color: #709870;">(</span>ServerSocket. <span style="color: #907373;">(</span><span style="color: #008b8b;">:port</span> options<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">]</span>
    <span style="color: #909183;">(</span>tcp-listener server handler<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #a020f0;">fn</span> <span style="color: #0000ff;">close</span> <span style="color: #709870;">[]</span> <span style="color: #709870;">(</span>.close server<span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388d6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
The <code>run-adapter</code> function returns a ~close function that we can keep a handle on when we want to close the server gracefully.
</p>

<p>
Our TCP listener requires a small modification. It receives an extra argument, the handler, which itself takes a request as argument and returns a response. This way, we are creating an abstraction external to the implementation details of our web server, its transport layer, etc. We are able to supply a Ring adapter to users who can now do webdev without giving a second thought to the underlying machinery. 
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">tcp-listener</span> <span style="color: #7388d6;">[</span>server f<span style="color: #7388d6;">]</span>
  <span style="color: #7388d6;">(</span><span style="color: #a020f0;">future</span>
    <span style="color: #909183;">(</span><span style="color: #a020f0;">try</span>
      <span style="color: #709870;">(</span><span style="color: #a020f0;">while</span> <span style="color: #907373;">(</span>not <span style="color: #6276ba;">(</span>.isClosed server<span style="color: #6276ba;">)</span><span style="color: #907373;">)</span>
        <span style="color: #907373;">(</span><span style="color: #a020f0;">loop</span> <span style="color: #6276ba;">[</span>conn <span style="color: #858580;">(</span>.accept server<span style="color: #858580;">)</span><span style="color: #6276ba;">]</span>
          <span style="color: #6276ba;">(</span><span style="color: #a020f0;">let</span> <span style="color: #858580;">[</span>request <span style="color: #80a880;">(</span>parse-request conn<span style="color: #80a880;">)</span><span style="color: #858580;">]</span>
            <span style="color: #858580;">(</span>send-response conn <span style="color: #80a880;">(</span>f request<span style="color: #80a880;">)</span><span style="color: #858580;">)</span><span style="color: #6276ba;">)</span>
          <span style="color: #6276ba;">(</span><span style="color: #a020f0;">recur</span> <span style="color: #858580;">(</span>.accept server<span style="color: #858580;">)</span><span style="color: #6276ba;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span>
      <span style="color: #709870;">(</span><span style="color: #a020f0;">catch</span> SocketException e <span style="color: #907373;">{</span><span style="color: #008b8b;">:msg</span> <span style="color: #6276ba;">(</span>.getMessage e<span style="color: #6276ba;">)</span><span style="color: #907373;">}</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388d6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
As to the underlying machinery, our ServerSocket that establishes TCP connections, well, TCP is a byte-stream protocol, and that is why our Ring adapter needs to transform the response&rsquo;s body to a byte-stream. Once the stream is passed down to the socket, TCP itself will chunk it and ensure that the data is reliably transferred over the network. The <i>StreamableResponseBody</i> protocol allows the user to pass different formats in the body of the response, as long as they satisfy the protocol. They all will be reduced to a stream of bytes. Out of the box, Ring comes with implementations for byte-arrays, strings, Clojure sequences, files and Java input streams. Since we are not relying on the Ring libraries but rather are referring to the spec (and building everything from scratch), we will re-implement some of them. 
</p>

<p>
It seems desirable that we always allow a string as body of a response. That will require an implementation for the <code>write-body-to-stream</code> protocol method for <i>String</i>.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #a020f0;">extend-protocol</span> StreamableResponseBody
  String
  <span style="color: #7388d6;">(</span>write-body-to-stream <span style="color: #909183;">[</span>body _ output-stream<span style="color: #909183;">]</span>
    <span style="color: #909183;">(</span>.write output-stream <span style="color: #709870;">(</span>.getBytes body<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>.close output-stream<span style="color: #909183;">)</span><span style="color: #7388d6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
However, consider the case of a static website. An index.html itself is a text file. As we&rsquo;ve done before, we could <i>slurp</i> it and pass the string to the java Writer. The latter will convert the characters to bytes before writing them to the underlying socket. However, when the browser receives the <i>index.html</i>, it will follow up with more requests as it encounters embedded links asking for CSS, scripts, images, fonts, etc. Some files, like the images or the fonts, are binary. <i>Slurping</i> them won&rsquo;t do us good. While all strings are bytes, not all bytes are strings.
</p>

<p>
Thus, a protocol method implementation for <i>java.io.File</i> seems highly useful, since it will cover all types of files, allowing us to serve an entire directory of static resources.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #a020f0;">extend-protocol</span> StreamableResponseBody
  File
  <span style="color: #7388d6;">(</span>write-body-to-stream <span style="color: #909183;">[</span>body _ output-stream<span style="color: #909183;">]</span>
    <span style="color: #909183;">(</span>.write output-stream <span style="color: #709870;">(</span><span style="color: #228b22;">Files</span>/readAllBytes <span style="color: #907373;">(</span>.toPath body<span style="color: #907373;">)</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>.flush output-stream<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>.close output-stream<span style="color: #909183;">)</span><span style="color: #7388d6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
Turning the body of the response into an output stream (of bytes) happens after we write the headers of the response to the output stream (as bytes). Therefore, the <code>send-response</code> function accounts for the fact that a response may have no body at all.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">send-response</span> <span style="color: #7388d6;">[</span>conn response<span style="color: #7388d6;">]</span>
  <span style="color: #7388d6;">(</span><span style="color: #a020f0;">cond-&gt;&gt;</span> <span style="color: #909183;">(</span>write-headers response <span style="color: #709870;">(</span>.getOutputStream conn<span style="color: #709870;">)</span><span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span><span style="color: #008b8b;">:body</span> response<span style="color: #909183;">)</span> <span style="color: #909183;">(</span>write-body-to-stream <span style="color: #709870;">(</span><span style="color: #008b8b;">:body</span> response<span style="color: #709870;">)</span> response<span style="color: #909183;">)</span><span style="color: #7388d6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
As for the write-headers function:
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">write-headers</span> <span style="color: #7388d6;">[</span>response output-stream<span style="color: #7388d6;">]</span>
  <span style="color: #7388d6;">(</span>.write output-stream <span style="color: #909183;">(</span>into-array <span style="color: #228b22;">Byte</span>/TYPE <span style="color: #709870;">(</span>str
                                               <span style="color: #907373;">(</span>get responses <span style="color: #6276ba;">(</span><span style="color: #008b8b;">:status</span> response<span style="color: #6276ba;">)</span><span style="color: #907373;">)</span>
                                               <span style="color: #907373;">(</span>apply str <span style="color: #6276ba;">(</span><span style="color: #a020f0;">for</span> <span style="color: #858580;">[</span><span style="color: #80a880;">[</span>k v<span style="color: #80a880;">]</span> <span style="color: #80a880;">(</span><span style="color: #008b8b;">:headers</span> response<span style="color: #80a880;">)</span><span style="color: #858580;">]</span> <span style="color: #858580;">(</span>str k <span style="color: #8b2252;">" "</span> v <span style="color: #8b2252;">"</span><span style="color: #8b2252; font-weight: bold;">\r\n</span><span style="color: #8b2252;">"</span><span style="color: #858580;">)</span><span style="color: #6276ba;">)</span><span style="color: #907373;">)</span>
                                               <span style="color: #8b2252;">"</span><span style="color: #8b2252; font-weight: bold;">\r\n</span><span style="color: #8b2252;">"</span><span style="color: #709870;">)</span><span style="color: #909183;">)</span><span style="color: #7388d6;">)</span>
  output-stream<span style="color: #707183;">)</span>
</pre>
</div>

<p>
The important point is that the <code>write-headers</code> function returns the output stream without closing it because it may be further processed. Indeed, if a body is present, we call the protocol method <code>write-body-to-stream</code>.
</p>

<p>
We are now able to completely detach application logic from our web server. Indeed, what a web application does depends entirely on what the user wants to do. The web server is a mere conduit, the infrastructure that supports application logic. Serving static resources under a folder becomes application logic. In the context of the Ring framework, it is a user-provided unit, separate and independent. It follows the rules of accepting a request and returning a response map.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">handler</span> <span style="color: #7388d6;">[</span>request<span style="color: #7388d6;">]</span>
  <span style="color: #7388d6;">(</span><span style="color: #a020f0;">let</span> <span style="color: #909183;">[</span>redirects <span style="color: #709870;">{</span><span style="color: #8b2252;">"/"</span> <span style="color: #8b2252;">"index.html"</span>
                   <span style="color: #8b2252;">"/index.htm"</span> <span style="color: #8b2252;">"index.html"</span><span style="color: #709870;">}</span>
        base-path <span style="color: #8b2252;">"/tmp/resources"</span><span style="color: #909183;">]</span>
    <span style="color: #909183;">(</span><span style="color: #a020f0;">cond</span>
      <span style="color: #709870;">(</span>contains? redirects <span style="color: #907373;">(</span><span style="color: #008b8b;">:uri</span> request<span style="color: #907373;">)</span><span style="color: #709870;">)</span> <span style="color: #709870;">{</span><span style="color: #008b8b;">:status</span> 301
                                            <span style="color: #008b8b;">:headers</span> <span style="color: #907373;">{</span><span style="color: #8b2252;">"Location:"</span> <span style="color: #6276ba;">(</span>get redirects <span style="color: #858580;">(</span><span style="color: #008b8b;">:uri</span> request<span style="color: #858580;">)</span><span style="color: #6276ba;">)</span><span style="color: #907373;">}</span><span style="color: #709870;">}</span>
      <span style="color: #709870;">(</span>.exists <span style="color: #907373;">(</span><span style="color: #228b22;">io</span>/file <span style="color: #6276ba;">(</span>str base-path <span style="color: #858580;">(</span><span style="color: #008b8b;">:uri</span> request<span style="color: #858580;">)</span><span style="color: #6276ba;">)</span><span style="color: #907373;">)</span><span style="color: #709870;">)</span> <span style="color: #709870;">(</span><span style="color: #a020f0;">let</span> <span style="color: #907373;">[</span>file <span style="color: #6276ba;">(</span><span style="color: #228b22;">io</span>/file <span style="color: #858580;">(</span>str base-path <span style="color: #80a880;">(</span><span style="color: #008b8b;">:uri</span> request<span style="color: #80a880;">)</span><span style="color: #858580;">)</span><span style="color: #6276ba;">)</span>
                                                               content-type <span style="color: #6276ba;">(</span><span style="color: #228b22;">Files</span>/probeContentType <span style="color: #858580;">(</span>.toPath file<span style="color: #858580;">)</span><span style="color: #6276ba;">)</span><span style="color: #907373;">]</span>
                                                           <span style="color: #907373;">{</span><span style="color: #008b8b;">:status</span> 200
                                                            <span style="color: #008b8b;">:headers</span> <span style="color: #6276ba;">{</span><span style="color: #8b2252;">"Content-Type:"</span> content-type<span style="color: #6276ba;">}</span>
                                                            <span style="color: #008b8b;">:body</span> file<span style="color: #907373;">}</span><span style="color: #709870;">)</span>

      <span style="color: #008b8b;">:else</span> <span style="color: #709870;">{</span><span style="color: #008b8b;">:status</span> 404
             <span style="color: #008b8b;">:headers</span> <span style="color: #907373;">{</span><span style="color: #8b2252;">"Content-Type:"</span> <span style="color: #8b2252;">"text/html"</span><span style="color: #907373;">}</span>
             <span style="color: #008b8b;">:body</span> <span style="color: #8b2252;">"&lt;html&gt;404&lt;/html&gt;"</span><span style="color: #709870;">}</span><span style="color: #909183;">)</span><span style="color: #7388d6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
Here&rsquo;s the <a href="https://gist.github.com/danielsz/75b9efe83fb9e420915c97641413acfb">gist</a> of it.
</p>

<p>
What is often overlooked. It is little known. Note that there is nothing in the HTTP protocol tying it to TCP. We could write a web server on top of Unix domain sockets, for example. 
</p>

<p>
Optimizations on top of our quick hack. 
</p>

<p>
What we&rsquo;ll be leaving as an exercise for the reader:
</p>
<ul class="org-ul">
<li>support for more HTTP verbs</li>
<li>Explore concurrency primitives available on the JVM, as well as nio, nio2</li>
<li>Different transport, write a http server on top of another transport than TCP, for example Unix domain sockets.</li>
<li>Comparatively benchmark our hack for the heck of it</li>
<li>Zero copy transfers</li>
</ul>


<p>
in their natural environment, academia. 
For those who are not familiar with the informal education channel,  Youtube channel, it&rsquo;s an educational . British-based and the jolliness of it. The format is friendly. The presenters are filmed in their environment, and there is a conversation with someone behind the scenes, asking pertinent questions. Ideas are explained with the help of whiteboards, notebook papers, animation. Often in pseudo-code. But this one was different as it showed actual code. Writing a web server in 26 lines of code. One may ask, what is the point. Or what kind of web server. The answer is, a web server capable of serving static assets. A web server that you can direct a browser to, and display pages. A web server that responds to GET requests.
Replicating the exercise would be even more pointless than the original. But one thing immediately triggers a Lisper. The workflow. The edit/compile cycle. One can only despair at the state of affairs, so there is nothing else to do but to show the world and repeat. How to develop at a REPL. How much nicer it is. The second thing I would say is the style. There is coding, and there is coding with style. I laud the jolliness and the didactic delivery. But the code is imperative. Good functional programming practice.
The first step to demonstrate is the absolute minimal example. A web server that does nothing with the request (or logging it), and which responds OK to anything you say. A dumb web server. Responding to a request. Firing a browser and seeing the response. From our own server! In three lines of code. How awesome is that!
The beauty of this is that this small core has everything. A TCP socket that listens on a port. An input stream on which we gather the request, an output stream on which we respond. And maybe more importantly, the control flow, the looping construct that prepares a connection 
</p>



<p>
gobbledygook
And it&rsquo;s back to preaching the gospel. 
Ha! <i>La belle affaire</i>. Well, after all these years, , as the Computerphile video attests. And that is 
</p>

<p>
Sadly, REPL-based development is still far from being commonplace. So I&rsquo;ve asked myself, should I just keep trudging along like Lispers have done since time immemorial, or is it maybe a good time to preach the gospel? Oyez! Hear ye!  
</p>

<p>
know what it means to be lonely. We never want to be lonely again.
We are smug, delusional or too lonely. 
This works, but if you dereference the future. Although we are closing the server properly, we are not closing the underlying socket,  <code>(.accept server)</code>, so
</p>

<p>
A future returns the value of its body after it finishes. If we want to catch errors, we can do this
To fully exploit the future:
It is a cosmetic issue because upon closing the server we throw away that thread. Still.  
</p>

<p>
So far we&rsquo;ve only seen strings.
</p>

<p>
By satisfying the protocol for input streams, we are enabling the sending of all types of data. 
</p>

<p>
. It is up to the user to pass files, images, fonts, anything really
</p>

<p>
because the burden of transferring the data reliably is handled by TCP/IP, rather than by the application
Even thought so far we&rsquo;ve only seen strings being sent in the bod, I chose an input stream because this 
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #707183;">(</span><span style="color: #a020f0;">defn</span> <span style="color: #0000ff;">stream-bytes</span> <span style="color: #7388d6;">[</span>is<span style="color: #7388d6;">]</span>
  <span style="color: #7388d6;">(</span><span style="color: #a020f0;">let</span> <span style="color: #909183;">[</span>baos <span style="color: #709870;">(</span>java.io.ByteArrayOutputStream.<span style="color: #709870;">)</span><span style="color: #909183;">]</span>
    <span style="color: #909183;">(</span><span style="color: #228b22;">io</span>/copy is baos<span style="color: #909183;">)</span>
    <span style="color: #909183;">(</span>.toByteArray baos<span style="color: #909183;">)</span><span style="color: #7388d6;">)</span><span style="color: #707183;">)</span>
</pre>
</div>

<p>
But from a user&rsquo;s perspective, the handler 
</p>
</div>
</body>
</html>
